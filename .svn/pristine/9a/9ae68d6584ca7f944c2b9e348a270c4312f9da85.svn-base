using System;
using System.Collections.Generic;
using System.Windows.Forms;
using VOD.Lib;
using VOD.Lib.Models;

namespace VOD
{
    public partial class MainForm : Form
    {
        private User User { get; }
        private Danmaku Danmu { get; }
        private HttpClientEx HttpClient { get; }
        private const string BreakLine = "\r\n";
        public List<MusicModel> MusicList { get; }
        public MainForm()
        {
            InitializeComponent();

            MusicList = new List<MusicModel>();
            HttpClient = new HttpClientEx();
            User = new User(HttpClient);
            Danmu = new Danmaku(MusicList);
            Danmu.PlaySongEvt += Danmu_PlaySongEvt;
            Danmu.PrintEvt += Danmu_PrintEvt; ;
        }
        private void Danmu_PrintEvt(object sender, EventModel e)
        {
            printBox.Text += e.PrintMsg + BreakLine;
            printBox.ScrollToCaret();
            printBox.Focus();
            printBox.Select(printBox.TextLength, 0);
            printBox.ScrollToCaret();
        }
        private void Danmu_PlaySongEvt(object sender, EventModel e)
        {
            var url = e.MusicInfo.SongUrl;
            axWindowsMediaPlayer1.URL = url;
        }
        private async void MainForm_Load(object sender, EventArgs e)
        {
            var result = await User.Login("user".GetConfig(), "passwd".GetConfig());
            if (result) await Danmu.ConnectAsync();
        }
        private void MainForm_FormClosing(object sender, FormClosingEventArgs e)
        {
            try
            {
                Danmu.Dispose();
                HttpClient.Dispose();
            }
            catch { }
        }
    }
}