using System;
using System.Collections.Generic;
using System.Windows;
using System.Windows.Controls;
using VOD.Lib;
using VOD.Lib.Models;

namespace VOD.Wpf
{
    public partial class MainWindow : Window
    {
        private User User { get; }
        private Danmaku Danmu { get; }
        private HttpClientEx HttpClient { get; }
        private const string BreakLine = "\r\n";
        private static object LockObj { get; } = new object();
        public MainWindow()
        {
            InitializeComponent();

            HttpClient = new HttpClientEx();
            User = new User(HttpClient);
            Danmu = new Danmaku();
            Danmu.PlaySongEvt += Danmu_PlaySongEvt;
            Danmu.PrintEvt += Danmu_PrintEvt;
        }
        private async void Window_Loaded(object sender, RoutedEventArgs e)
        {
            var result = await User.Login("user".GetConfig(), "passwd".GetConfig());
            if (result)
                await Danmu.ConnectAsync();
        }
        private void Window_Unloaded(object sender, RoutedEventArgs e)
        {
            try
            {
                Danmu.Dispose();
                HttpClient.Dispose();
            }
            catch { }
        }
        private void Danmu_PlaySongEvt(object sender, EventModel e)
        {
            lock (LockObj)
            {
                songList.Items.Add(e.MusicInfo);
                player.Source = new Uri(e.MusicInfo.SongUrl, UriKind.RelativeOrAbsolute);
                player.Tag = e.MusicInfo.SongId;
                player.Play();
                btnState.Content = "暂停";
            }
        }
        private void Danmu_PrintEvt(object sender, EventModel e)
        {
            printBox.Text += e.PrintMsg + BreakLine;
        }
        private void btnState_Click(object sender, RoutedEventArgs e)
        {
            if (btnState.Content.ToString() == "播放")
            {
                player.Play();
                btnState.Content = "暂停";
            }
            else
            {
                player.Pause();
                btnState.Content = "播放";
            }
        }
        private void btnNext_Click(object sender, RoutedEventArgs e)
        {
            var songId = Guid.Parse(player.Tag.ToString());
            var item = songList.Items.Find(x => x.SongId == songId);
            if (item != null)
            {
                songList.Items.Remove(item);
                var next = songList.Items.Get(0);
                if (next != null)
                {
                    player.Source = new Uri(next.SongUrl, UriKind.RelativeOrAbsolute);
                    player.Tag = next.SongId;
                    player.Play();
                    btnState.Content = "暂停";
                }
            }
        }
        private void btnOpen_Click(object sender, RoutedEventArgs e)
        {

        }
    }
}