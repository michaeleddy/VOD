using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;
using VOD.Lib;
using VOD.Lib.Models;
using WMPLib;

namespace VOD
{
    public partial class MainForm : Form
    {
        private User User { get; }
        private Danmaku Danmu { get; }
        private HttpClientEx HttpClient { get; }
        private WindowsMediaPlayer Player { get; }
        private const string BreakLine = "\r\n";
        public MainForm()
        {
            InitializeComponent();

            HttpClient = new HttpClientEx();
            User = new User(HttpClient);
            //Player = new WindowsMediaPlayer();
            Danmu = new Danmaku();
            Danmu.PlaySongEvt += Danmu_PlaySongEvt;
            Danmu.PrintEvt += Danmu_PrintEvt; ;
            LoadInit();
        }
        private void Danmu_PrintEvt(object sender, EventModel e)
        {
            printBox.Text += e.PrintMsg + BreakLine;
            printBox.ScrollToCaret();
            printBox.Focus();
            printBox.Select(printBox.TextLength, 0);
            printBox.ScrollToCaret();
        }
        private void Danmu_PlaySongEvt(object sender, EventModel e)
        {

        }
        private async void LoadInit()
        {
            var result = await User.Login("user".GetConfig(), "passwd".GetConfig());
            if (result)
            {
                await Danmu.ConnectAsync();
                try
                {
                    Player.MediaError += Player_MediaError;
                    Player.PlayStateChange += Player_PlayStateChange;
                }
                catch { }
            }
        }
        private void Play(string url)
        {
            Player.URL = url;
            Player.controls.play();
        }
        private void Player_PlayStateChange(int newState)
        {

        }
        private void Player_MediaError(object mediaObject)
        {

        }
        private void MainForm_Load(object sender, EventArgs e)
        {

        }
        private void MainForm_FormClosing(object sender, FormClosingEventArgs e)
        {
            try
            {
                Player.close();
                Danmu.Dispose();
                HttpClient.Dispose();
                Player.MediaError -= Player_MediaError;
                Player.PlayStateChange -= Player_PlayStateChange;
            }
            catch { }
        }
    }
}